# 勤怠管理システム設計書

## 1. システム概要

### 1.1 目的
時給ベースの勤怠管理システムを構築し、出勤・退勤・休憩時間の記録から給与計算までを一元管理する。

### 1.2 主要機能
- 出勤/退勤時刻の記録
- 休憩時間の記録（複数回対応）
- 時給単価の設定・管理
- 月次労働時間・給与サマリーの表示
- 勤怠データの編集・削除

### 1.3 時刻の取り扱い
- **タイムゾーン**: JST（日本標準時）
- すべての時刻データはJSTで統一して管理・表示する
- データベースではTIMESTAMP WITH TIME ZONEを使用してJSTで保存
- フロントエンドでの表示もJSTベースで行う

### 1.4 技術スタック
- **フロントエンド**: Next.js 14 (App Router)
- **バックエンド**: FastAPI (Python 3.11+)
- **データベース**: PostgreSQL 15
- **コンテナ**: Docker & Docker Compose
- **UI/UX**: TailwindCSS + Shadcn/ui（Modern Google-like Design）

## 2. システムアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Next.js App   │───▶│   FastAPI       │───▶│   PostgreSQL    │
│   (Frontend)    │    │   (Backend)     │    │   (Database)    │
│   Port: 3000    │    │   Port: 8000    │    │   Port: 5432    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                        │                        │
        └────────────────────────┼────────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Docker        │
                    │   Network       │
                    └─────────────────┘
```

## 3. データベース設計

### 3.1 ERD
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     users       │    │   attendance    │    │   break_times   │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ id (PK)         │◀───│ user_id (FK)    │    │ attendance_id   │
│ name            │    │ id (PK)         │───▶│ (FK)            │
│ email           │    │ date            │    │ id (PK)         │
│ hourly_rate     │    │ clock_in        │    │ start_time      │
│ created_at      │    │ clock_out       │    │ end_time        │
│ updated_at      │    │ total_hours     │    │ duration        │
└─────────────────┘    │ total_amount    │    │ created_at      │
                       │ created_at      │    │ updated_at      │
                       │ updated_at      │    └─────────────────┘
                       └─────────────────┘
```

### 3.2 テーブル定義

#### users テーブル
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    hourly_rate DECIMAL(10,2) DEFAULT 1000.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### attendance テーブル
```sql
CREATE TABLE attendance (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    clock_in TIME,
    clock_out TIME,
    total_hours DECIMAL(5,2) DEFAULT 0,
    total_amount DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, date)
);
```

#### break_times テーブル
```sql
CREATE TABLE break_times (
    id SERIAL PRIMARY KEY,
    attendance_id INTEGER REFERENCES attendance(id) ON DELETE CASCADE,
    start_time TIME NOT NULL,
    end_time TIME,
    duration INTEGER DEFAULT 0, -- 分単位
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. API設計

### 4.1 エンドポイント一覧

#### 認証・ユーザー管理
```
GET    /api/users/me              # ユーザー情報取得
PUT    /api/users/me              # ユーザー情報更新
PUT    /api/users/me/hourly-rate  # 時給更新
```

#### 勤怠管理
```
POST   /api/attendance/clock-in   # 出勤記録
POST   /api/attendance/clock-out  # 退勤記録
GET    /api/attendance/today      # 今日の勤怠取得
GET    /api/attendance            # 勤怠一覧（月別フィルタ）
PUT    /api/attendance/{id}       # 勤怠更新
DELETE /api/attendance/{id}       # 勤怠削除
```

#### 休憩時間管理
```
POST   /api/breaks/start          # 休憩開始
POST   /api/breaks/end            # 休憩終了
GET    /api/breaks/{attendance_id} # 休憩時間一覧
PUT    /api/breaks/{id}           # 休憩時間更新
DELETE /api/breaks/{id}           # 休憩時間削除
```

#### レポート
```
GET    /api/reports/monthly       # 月次サマリー
GET    /api/reports/yearly        # 年次サマリー
```

### 4.2 レスポンス例

#### GET /api/attendance/today
```json
{
  "data": {
    "id": 1,
    "date": "2025-06-10",
    "clock_in": "09:00:00",
    "clock_out": "18:00:00",
    "total_hours": 8.0,
    "total_amount": 8000.00,
    "break_times": [
      {
        "id": 1,
        "start_time": "12:00:00",
        "end_time": "13:00:00",
        "duration": 60
      }
    ]
  }
}
```

#### GET /api/reports/monthly
```json
{
  "data": {
    "year": 2025,
    "month": 6,
    "total_days": 22,
    "total_hours": 176.0,
    "total_amount": 176000.00,
    "average_daily_hours": 8.0,
    "attendance_list": [...]
  }
}
```

## 5. フロントエンド設計

### 5.1 ページ構成
```
/                    # ダッシュボード（今日の勤怠状況）
/attendance          # 勤怠一覧・編集
/reports             # 月次・年次レポート
/settings            # 設定（時給など）
```

### 5.2 コンポーネント設計

#### 主要コンポーネント
```
components/
├── ui/                    # shadcn/ui基本コンポーネント
├── layout/
│   ├── Header.tsx         # ヘッダー
│   ├── Sidebar.tsx        # サイドバー
│   └── Layout.tsx         # 全体レイアウト
├── attendance/
│   ├── ClockInButton.tsx  # 出勤ボタン
│   ├── ClockOutButton.tsx # 退勤ボタン
│   ├── BreakTimer.tsx     # 休憩タイマー
│   ├── AttendanceCard.tsx # 勤怠カード（編集・削除機能付き）
│   └── AttendanceList.tsx # 勤怠一覧（月別フィルタリング機能付き）
├── reports/
│   ├── MonthlySummary.tsx # 月次サマリー
│   ├── YearlySummary.tsx  # 年次サマリー
│   └── Charts.tsx         # グラフ表示
├── forms/
│   ├── EditAttendanceDialog.tsx # 勤怠編集ダイアログ（休憩時間管理機能付き）
│   └── SettingsForm.tsx         # 設定フォーム
├── common/
│   └── DeleteConfirmDialog.tsx  # 削除確認ダイアログ
└── hooks/
    └── useAttendance.ts         # 勤怠データ管理カスタムフック
```

### 5.3 デザインシステム

#### カラーパレット（Google風）
```css
:root {
  --primary: #1a73e8;        /* Google Blue */
  --primary-dark: #1557b0;
  --surface: #ffffff;
  --surface-variant: #f8f9fa;
  --on-surface: #202124;
  --on-surface-variant: #5f6368;
  --outline: #dadce0;
  --success: #34a853;
  --warning: #fbbc04;
  --error: #ea4335;
}
```

#### タイポグラフィ
```css
.text-display {
  font-family: 'Google Sans', sans-serif;
  font-size: 3.5rem;
  font-weight: 400;
  line-height: 1.2;
}

.text-headline {
  font-family: 'Google Sans', sans-serif;
  font-size: 2rem;
  font-weight: 400;
  line-height: 1.25;
}

.text-body {
  font-family: 'Roboto', sans-serif;
  font-size: 1rem;
  font-weight: 400;
  line-height: 1.5;
}
```

## 6. Docker構成

### 6.1 docker-compose.yml
```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8000
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@database:5432/attendance_db
    depends_on:
      - database
    volumes:
      - ./backend:/app

  database:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=attendance_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  postgres_data:
```

## 7. ディレクトリ構造

```
attendance-system/
├── docker-compose.yml
├── init.sql
├── README.md
├── frontend/
│   ├── Dockerfile
│   ├── package.json
│   ├── next.config.js
│   ├── tailwind.config.js
│   ├── src/
│   │   ├── app/
│   │   │   ├── layout.tsx
│   │   │   ├── page.tsx
│   │   │   ├── attendance/
│   │   │   ├── reports/
│   │   │   └── settings/
│   │   ├── components/
│   │   ├── lib/
│   │   ├── hooks/
│   │   └── types/
│   └── public/
└── backend/
    ├── Dockerfile
    ├── requirements.txt
    ├── main.py
    ├── app/
    │   ├── __init__.py
    │   ├── core/
    │   │   ├── config.py
    │   │   └── database.py
    │   ├── models/
    │   │   ├── __init__.py
    │   │   ├── user.py
    │   │   ├── attendance.py
    │   │   └── break_time.py
    │   ├── schemas/
    │   ├── api/
    │   │   ├── __init__.py
    │   │   ├── routes/
    │   │   └── dependencies.py
    │   ├── services/
    │   └── utils/
    └── tests/
```

## 8. 実装仕様

### 8.1 状態管理
- **フロントエンド**: Zustand + React Query
- **データフェッチング**: TanStack Query (React Query)
- **フォーム管理**: React Hook Form + Zod

### 8.2 認証
- **方式**: JWT Token (簡易実装)
- **セッション管理**: localStorage + httpOnly Cookie

### 8.3 バリデーション
- **フロントエンド**: Zod schema
- **バックエンド**: Pydantic models

### 8.4 エラーハンドリング
- **API**: 統一されたエラーレスポンス形式
- **UI**: Toast通知 + エラーバウンダリ

### 8.5 パフォーマンス
- **フロントエンド**: Code splitting, Image optimization
- **バックエンド**: Connection pooling, Query optimization
- **キャッシュ**: React Query caching

## 9. 開発・デプロイ手順

### 9.1 開発環境セットアップ
```bash
# リポジトリクローン
git clone <repository-url>
cd attendance-system

# Docker環境起動
docker-compose up -d

# データベース初期化
docker-compose exec backend alembic upgrade head
```

### 9.2 開発フロー
1. **Docker環境での開発**: ホットリロード対応
2. **API仕様書**: FastAPI自動生成 (`http://localhost:8000/docs`)
3. **テスト**: pytest (Backend) + Jest (Frontend)

## 10. 追加考慮事項

### 10.1 セキュリティ
- CORS設定
- SQL Injection対策
- XSS対策
- CSRF対策

### 10.2 拡張性
- マルチテナント対応準備
- 権限管理システム
- 外部API連携準備

### 10.3 監視・ログ
- アプリケーションログ
- エラー監視
- パフォーマンス監視

## 11. 実装済み機能

### 11.1 勤怠一覧画面（/attendance）

#### 機能概要
- 月別の勤怠記録の一覧表示
- 勤怠記録の編集・削除機能
- 月次サマリー（総勤務日数、総勤務時間、給与総額）の表示
- 月選択による表示期間の切り替え

#### 実装コンポーネント
1. **AttendancePage** (`app/attendance/page.tsx`)
   - 月次サマリーカードの表示
   - AttendanceListコンポーネントのラッパー

2. **AttendanceList** (`components/attendance/AttendanceList.tsx`)
   - 月選択コントロール（年・月のドロップダウン、前後移動ボタン）
   - 勤怠データの一覧表示
   - 編集・削除ダイアログの制御

3. **AttendanceCard** (`components/attendance/AttendanceCard.tsx`)
   - 個別勤怠データの表示カード
   - 週末判定によるスタイリング
   - 出勤・退勤時刻、休憩時間、勤務時間、給与の表示
   - 編集・削除ボタン（showActionsプロパティで制御）

4. **EditAttendanceDialog** (`components/forms/EditAttendanceDialog.tsx`)
   - 出勤・退勤時刻の編集
   - 休憩時間の追加・編集・削除
   - 自動的な勤務時間計算

5. **DeleteConfirmDialog** (`components/common/DeleteConfirmDialog.tsx`)
   - 削除確認のための汎用ダイアログ

6. **useAttendance** (`hooks/useAttendance.ts`)
   - 勤怠データのCRUD操作
   - React Queryを使用したデータフェッチング・キャッシング
   - 楽観的更新とエラーハンドリング

#### 追加実装の特徴
- 週末の勤怠記録は背景色を変更して視覚的に区別
- 休憩時間の詳細表示（複数回の休憩に対応）
- 日付の日本語表記（曜日表示含む）
- レスポンシブデザイン（モバイル対応）

---

この設計書に基づいて、Claude Codeでの実装を進めることができます。各セクションは実装時の具体的な指針となるよう詳細に記述されています。
